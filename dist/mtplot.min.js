!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MTPlot={})}(this,(function(t){"use strict";const e="http://www.w3.org/2000/svg";class i{constructor(t,i,s){this.width=i,this.height=s,this.svg=document.createElementNS(e,"svg"),this.svg.setAttribute("width",i.toString()),this.svg.setAttribute("height",s.toString()),this.svg.setAttribute("class","mtplot-svg"),this.defs=document.createElementNS(e,"defs"),this.svg.appendChild(this.defs),this.mainGroup=document.createElementNS(e,"g"),this.svg.appendChild(this.mainGroup),this.tooltipBackground=document.createElementNS(e,"rect"),this.tooltipBackground.setAttribute("class","mtplot-tooltip-bg"),this.tooltipBackground.setAttribute("rx","4"),this.tooltipBackground.setAttribute("ry","4"),this.tooltipBackground.setAttribute("fill","white"),this.tooltipBackground.setAttribute("stroke","#ccc"),this.tooltipBackground.style.display="none",this.tooltip=document.createElementNS(e,"text"),this.tooltip.setAttribute("class","mtplot-tooltip"),this.tooltip.style.display="none",this.svg.appendChild(this.tooltipBackground),this.svg.appendChild(this.tooltip),this.setupSVG(t,i,s),this.setupInteraction()}setupSVG(t,e,i){[["version","1.1"],["viewBox",`0 0 ${e} ${i}`],["preserveAspectRatio","none"],["style","width: 100%; height: 100%;"]].forEach((([t,e])=>{this.svg.setAttribute(t,e)})),t.appendChild(this.svg)}setupInteraction(){let t=!1,e=0,i=0,s={x:0,y:0,scale:1};this.svg.addEventListener("mousedown",(s=>{t=!0,e=s.clientX,i=s.clientY})),this.svg.addEventListener("mousemove",(n=>{if(!t)return;const o=n.clientX-e,a=n.clientY-i;s.x+=o,s.y+=a,e=n.clientX,i=n.clientY,this.updateTransform(s)})),this.svg.addEventListener("mouseup",(()=>{t=!1})),this.svg.addEventListener("wheel",(t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1;s.scale*=e,this.updateTransform(s)}))}updateTransform(t){this.mainGroup.setAttribute("transform",`translate(${t.x},${t.y}) scale(${t.scale})`)}resize(t,e){this.width=t,this.height=e,this.svg.setAttribute("width",t.toString()),this.svg.setAttribute("height",e.toString()),this.svg.setAttribute("viewBox",`0 0 ${t} ${e}`)}clear(){for(;this.mainGroup.firstChild;)this.mainGroup.removeChild(this.mainGroup.firstChild)}drawBar(t,i,s,n,o,a={}){const r=document.createElementNS(e,"rect");r.setAttribute("x",t.toString()),r.setAttribute("y",i.toString()),r.setAttribute("width",s.toString()),r.setAttribute("height",n.toString()),a.highContrast?(r.setAttribute("fill",this.getHighContrastColor(o)),r.setAttribute("stroke","black"),r.setAttribute("stroke-width","2")):r.setAttribute("fill",o),a.interactive&&(r.setAttribute("data-tooltip",a.tooltip||""),r.style.cursor="pointer",this.setupBarInteraction(r)),this.mainGroup.appendChild(r)}getHighContrastColor(t){const e=this.hexToRgb(t);if(!e)return t;return(299*e.r+587*e.g+114*e.b)/1e3>128?"#000000":"#FFFFFF"}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}setupBarInteraction(t){t.addEventListener("mouseenter",(e=>{const i=t.getAttribute("data-tooltip");i&&this.showTooltip(i,e.clientX,e.clientY)})),t.addEventListener("mouseleave",(()=>{this.hideTooltip()}))}showTooltip(t,i,s){const n=t.split("\n").join(" ");for(;this.tooltip.firstChild;)this.tooltip.removeChild(this.tooltip.firstChild);const o=document.createElementNS(e,"tspan");o.textContent=n,o.setAttribute("x","0"),this.tooltip.appendChild(o);const a=this.tooltip.getBBox(),r=a.width+16,h=a.height+16;o.setAttribute("y",(8+a.height).toString());let l=i+10,c=s-h-10;l+r>this.width&&(l=i-r-10),c<0&&(c=s+20),l=Math.max(5,Math.min(this.width-r-5,l)),c=Math.max(5,Math.min(this.height-h-5,c)),this.tooltip.setAttribute("transform",`translate(${l}, ${c})`),this.tooltipBackground.setAttribute("x",l.toString()),this.tooltipBackground.setAttribute("y",c.toString()),this.tooltipBackground.setAttribute("width",r.toString()),this.tooltipBackground.setAttribute("height",h.toString()),this.tooltipBackground.style.display="",this.tooltip.style.display=""}hideTooltip(){this.tooltipBackground.style.display="none",this.tooltip.style.display="none"}drawPattern(t,i,s,n,o,a){const r=document.createElementNS(e,"rect");if(r.setAttribute("x",t.toString()),r.setAttribute("y",i.toString()),r.setAttribute("width",s.toString()),r.setAttribute("height",n.toString()),r.setAttribute("fill",o),r.setAttribute("fill-opacity","0.3"),a)switch(a){case"lowValue":r.setAttribute("stroke","red"),r.setAttribute("stroke-dasharray","4,4");break;case"stagnation":r.setAttribute("stroke","orange"),r.setAttribute("stroke-width","2")}this.mainGroup.appendChild(r)}drawText(t,i,s,n={}){const o=document.createElementNS(e,"text"),a=[["x",t.toString()],["y",i.toString()],["fill",n.color||"black"],["font-family",n.fontFamily||"monospace"],["font-size",(n.fontSize||12).toString()]];n.stroke&&(a.push(["stroke",n.stroke]),a.push(["stroke-width",(n.strokeWidth||1).toString()])),a.forEach((([t,e])=>o.setAttribute(t,e))),o.textContent=s,this.mainGroup.appendChild(o)}getSVGElement(){return this.svg}}class s{constructor(t){this.threshold=t.threshold,this.consecutiveDays=t.consecutiveDays}findPatterns(t){if(t.length<this.consecutiveDays)return[];const e=[],i=this.calculateValueRange(t),s=Math.min(...t.map((t=>t.y)))+i*this.threshold;let n=[];return t.forEach(((i,o)=>{i.y<=s?n.push(o):(this.isValidSequence(n,t)&&e.push({start:n[0],end:n[n.length-1]}),n=[])})),this.isValidSequence(n,t)&&e.push({start:n[0],end:n[n.length-1]}),e}calculateValueRange(t){const e=t.map((t=>t.y));return Math.max(...e)-Math.min(...e)}isValidSequence(t,e){if(t.length<this.consecutiveDays)return!1;for(let i=1;i<t.length;i++){if((e[t[i]].x.valueOf()-e[t[i-1]].x.valueOf())/864e5>1.1)return!1}return!0}}class n{constructor(t){this.consecutiveDays=t.consecutiveDays,this.changeThreshold=t.changeThreshold,this.activeChangePercentage=t.activeChangePercentage}findPatterns(t){if(t.length<this.consecutiveDays)return[];const e=[],i=this.calculateAverageChange(t);if(!this.hasEnoughActiveChanges(t,i))return[];let s=[];const n=i*this.changeThreshold;return t.forEach(((i,o)=>{s.push(o),(o===t.length-1||Math.abs(t[o+1].y-i.y)>n)&&(this.isStagnationPeriod(s,t,n)&&e.push({start:s[0],end:s[s.length-1]}),s=[])})),e}calculateAverageChange(t){if(t.length<2)return 0;let e=0,i=0;for(let s=1;s<t.length;s++){const n=Math.abs(t[s].y-t[s-1].y);n>0&&(e+=n,i++)}return i>0?e/i:0}hasEnoughActiveChanges(t,e){if(t.length<2)return!1;let i=0;const s=e*this.changeThreshold;for(let e=1;e<t.length;e++){Math.abs(t[e].y-t[e-1].y)>s&&i++}return i/(t.length-1)>=this.activeChangePercentage}isStagnationPeriod(t,e,i){if(t.length<this.consecutiveDays)return!1;for(let i=1;i<t.length;i++){if((e[t[i]].x.valueOf()-e[t[i-1]].x.valueOf())/864e5>1.1)return!1}for(let s=1;s<t.length;s++){if(Math.abs(e[t[s]].y-e[t[s-1]].y)>i)return!1}return!0}}function o(t){return 0===t.length?0:t.reduce(((t,e)=>t+e),0)/t.length}function a(t){if(0===t.length)return 0;const e=[...t].sort(((t,e)=>t-e)),i=Math.floor(e.length/2);return e.length%2==0?(e[i-1]+e[i])/2:e[i]}function r(t,e){if(e<1||e>t.length)return t;const i=[];for(let s=0;s<t.length-e+1;s++){const n=t.slice(s,s+e);i.push(o(n))}return i}function h(t){return t.toISOString()}const l={width:800,height:400,theme:{barColor:"black",barHoverColor:"blue",lowValueColor:"rgba(255,0,0,0.2)",stagnationColor:"rgba(255,165,0,0.2)",backgroundColor:"white",textColor:"black",fontFamily:"monospace",fontSize:12},patterns:{lowValue:{threshold:.02,consecutiveDays:2},stagnation:{consecutiveDays:3,changeThreshold:.2,activeChangePercentage:.85}},responsive:!0,accessibility:{enableKeyboardNavigation:!0,enableScreenReader:!0,highContrast:!1,ariaLabel:"Time series chart"},interaction:{enableZoom:!0,enablePan:!0,tooltipFormat:t=>`${h(t.x)}: ${t.y}`,onPointClick:void 0},performance:{enableVirtualization:!0,clusteringThreshold:1e3,useWebWorker:!0}};t.MTPlot=class{constructor(t,e=[],o={}){var a,r;this.isDirty=!1,this.updateTimeout=null,this.refreshDelay=100,this.resizeObserver=null,this.tooltip=null,this.worker=null,this.zoom={scale:1,offset:{x:0,y:0}};const h=document.getElementById(t);if(!h)throw new Error(`No element found with id: ${t}`);this.container=h,this.options={...l,...o},this.setupTooltip(),(null===(a=this.options.performance)||void 0===a?void 0:a.useWebWorker)&&this.setupWebWorker(),this.renderer=new i(h,this.getWidth(),this.getHeight()),(null===(r=this.options.accessibility)||void 0===r?void 0:r.enableScreenReader)&&this.setupAccessibility(),this.data=this.processInitialData(e),this.lowValueDetector=new s(this.options.patterns.lowValue),this.stagnationDetector=new n(this.options.patterns.stagnation),this.setupEventListeners(),this.options.responsive&&this.setupResponsive(),this.update()}setupTooltip(){this.tooltip=document.createElement("div"),this.tooltip.style.cssText="\n      position: absolute;\n      display: none;\n      background: white;\n      border: 1px solid #ccc;\n      padding: 8px;\n      border-radius: 4px;\n      pointer-events: none;\n      z-index: 1000;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    ",document.body.appendChild(this.tooltip)}setupWebWorker(){const t=new Blob(["\n      self.onmessage = function(e) {\n        const { data, patterns } = e.data;\n        const results = {\n          lowValue: findLowValuePatterns(data, patterns.lowValue),\n          stagnation: findStagnationPatterns(data, patterns.stagnation)\n        };\n        self.postMessage(results);\n      };\n    "],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.onmessage=t=>{this.handleWorkerResults(t.data)}}setupAccessibility(){var t,e;const i=this.renderer.getSVGElement();i.setAttribute("role","img"),i.setAttribute("aria-label",(null===(t=this.options.accessibility)||void 0===t?void 0:t.ariaLabel)||"Time series chart"),(null===(e=this.options.accessibility)||void 0===e?void 0:e.enableKeyboardNavigation)&&(i.setAttribute("tabindex","0"),i.addEventListener("keydown",this.handleKeyboardNavigation.bind(this)))}setupResponsive(){this.resizeObserver=new ResizeObserver((t=>{for(const e of t)e.target===this.container&&this.handleResize()})),this.resizeObserver.observe(this.container)}getWidth(){return this.options.responsive?this.container.clientWidth:this.options.width}getHeight(){return this.options.responsive?this.container.clientHeight:this.options.height}processInitialData(t){var e,i;let s=[...t].sort(((t,e)=>t.x.valueOf()-e.x.valueOf()));return(null===(e=this.options.performance)||void 0===e?void 0:e.enableVirtualization)&&s.length>((null===(i=this.options.performance)||void 0===i?void 0:i.clusteringThreshold)||1e3)&&(s=this.clusterData(s)),s}clusterData(t){const e=Math.floor(t.length/this.getWidth());if(e<=1)return t;const i=[];for(let s=0;s<t.length;s+=e){const n=t.slice(s,s+e),o=new Date(n.reduce(((t,e)=>t+e.x.valueOf()),0)/n.length),a=n.reduce(((t,e)=>t+e.y),0)/n.length;i.push({x:o,y:a})}return i}handleResize(){this.renderer.resize(this.getWidth(),this.getHeight()),this.triggerUpdate()}handleKeyboardNavigation(t){var e;if(null===(e=this.options.accessibility)||void 0===e?void 0:e.enableKeyboardNavigation){switch(t.key){case"ArrowLeft":this.zoom.offset.x-=10;break;case"ArrowRight":this.zoom.offset.x+=10;break;case"ArrowUp":this.zoom.scale*=1.1;break;case"ArrowDown":this.zoom.scale/=1.1}this.triggerUpdate()}}handleWorkerResults(t){this.drawPatterns(this.calculateValueRange(),this.calculateTimeRange())}setupEventListeners(){this.container.addEventListener("mousemove",(t=>{var e,i;const s=this.container.getBoundingClientRect(),n=t.clientX-s.left;t.clientY,s.top;const o=this.calculateTimeRange(),a=this.getTimeFromX(n,o),r=this.findClosestPoint(a);if(r){const s=(null===(i=null===(e=this.options.interaction)||void 0===e?void 0:e.tooltipFormat)||void 0===i?void 0:i.call(e,r))||`Date: ${r.x.toLocaleDateString()}, Value: ${r.y.toFixed(2)}`;this.renderer.showTooltip(s,t.clientX,t.clientY)}})),this.container.addEventListener("mouseleave",(()=>{this.renderer.hideTooltip()}));new ResizeObserver((()=>{this.triggerUpdate()})).observe(this.container),this.container.tabIndex=0,this.container.addEventListener("keydown",this.handleKeyboardNavigation.bind(this))}getTimeFromX(t,e){const i=t/this.options.width;return e.min+(e.max-e.min)*i}findClosestPoint(t){if(!this.data.length)return null;let e=this.data[0],i=Math.abs(e.x.valueOf()-t);for(const s of this.data){const n=Math.abs(s.x.valueOf()-t);n<i&&(i=n,e=s)}return e}setTheme(t){this.options.theme={...this.options.theme,...t},this.triggerUpdate()}setPatternOptions(t){t.lowValue&&(this.lowValueDetector=new s({...this.options.patterns.lowValue,...t.lowValue})),t.stagnation&&(this.stagnationDetector=new n({...this.options.patterns.stagnation,...t.stagnation})),this.options.patterns={...this.options.patterns,...t},this.triggerUpdate()}addData(t){this.data.push(t),this.data.sort(((t,e)=>t.x.valueOf()-e.x.valueOf())),this.triggerUpdate()}removeOldest(){this.data.length>0&&(this.data.shift(),this.triggerUpdate())}replaceOldest(t){this.data.length>0&&(this.data[0]=t,this.data.sort(((t,e)=>t.x.valueOf()-e.x.valueOf())),this.triggerUpdate())}triggerUpdate(){this.updateTimeout&&window.clearTimeout(this.updateTimeout),this.isDirty=!0,this.updateTimeout=window.setTimeout((()=>{this.update(),this.updateTimeout=null}),this.refreshDelay)}update(){if(!this.isDirty)return;if(this.renderer.clear(),0===this.data.length)return;const{width:t,height:e}=this.options,i=this.calculateValueRange(),s=this.calculateTimeRange();this.drawPatterns(i,s),this.drawBars(i,s),this.drawStatistics(i),this.isDirty=!1}calculateValueRange(){const t=this.data.map((t=>t.y));return{min:Math.min(...t),max:Math.max(...t)}}calculateTimeRange(){return{min:this.data[0].x.valueOf(),max:this.data[this.data.length-1].x.valueOf()}}drawPatterns(t,e){this.lowValueDetector.findPatterns(this.data).forEach((t=>{const i=this.getXPosition(this.data[t.start].x,e),s=this.getXPosition(this.data[t.end].x,e);this.renderer.drawPattern(i,0,s-i,this.getHeight(),this.options.theme.lowValueColor,"lowValue")}));this.stagnationDetector.findPatterns(this.data).forEach((t=>{const i=this.getXPosition(this.data[t.start].x,e),s=this.getXPosition(this.data[t.end].x,e);this.renderer.drawPattern(i,0,s-i,this.getHeight(),this.options.theme.stagnationColor,"stagnation")}))}drawBars(t,e){var i,s,n;for(let o=0;o<this.data.length;o++){const a=this.data[o],r=this.data[o+1],h=this.getXPosition(a.x,e),l=this.scaleY(a.y,t),c=r?this.getXPosition(r.x,e)-h:10,u=this.options.height-l,d=(null===(s=null===(i=this.options.interaction)||void 0===i?void 0:i.tooltipFormat)||void 0===s?void 0:s.call(i,a))||`Date: ${a.x.toLocaleDateString()}, Value: ${a.y.toFixed(2)}`;this.renderer.drawBar(h,l,c,u,this.options.theme.barColor,{interactive:!0,tooltip:d,highContrast:null===(n=this.options.accessibility)||void 0===n?void 0:n.highContrast})}}drawStatistics(t){const e=this.data.map((t=>t.y)),i=o(e),s=a(e);this.renderer.drawPattern(0,this.scaleY(i,t),this.options.width,1,"rgba(0,0,255,0.5)"),this.renderer.drawPattern(0,this.scaleY(s,t),this.options.width,1,"rgba(0,255,0,0.5)")}getXPosition(t,e){return(t.valueOf()-e.min)/(e.max-e.min)*this.options.width}scaleY(t,e){return this.options.height-(t-e.min)/(e.max-e.min)*this.options.height}getStatistics(){const t=this.data.map((t=>t.y));return{mean:o(t),median:a(t),movingAverage:r(t,5)}}exportToCSV(){return[["Date","Value"],...this.data.map((t=>[t.x.toISOString(),t.y.toString()]))].map((t=>t.join(","))).join("\n")}exportToSVG(){return this.renderer.getSVGElement().outerHTML}},t.calculateMean=o,t.calculateMedian=a,t.calculateMovingAverage=r,t.calculatePercentile=function(t,e){if(0===t.length)return 0;if(e<0||e>100)throw new Error("Percentile must be between 0 and 100");const i=[...t].sort(((t,e)=>t-e)),s=e/100*(i.length-1),n=Math.floor(s),o=Math.ceil(s);if(n===o)return i[n];const a=s-n;return i[n]*(1-a)+i[o]*a},t.calculateStandardDeviation=function(t){if(t.length<2)return 0;const e=o(t),i=o(t.map((t=>Math.pow(t-e,2))));return Math.sqrt(i)},t.formatDate=h,t.getDateRange=function(t){return{min:new Date(Math.min(...t.map((t=>t.valueOf())))),max:new Date(Math.max(...t.map((t=>t.valueOf()))))}}}));
//# sourceMappingURL=mtplot.min.js.map
