!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MTPlot={})}(this,(function(t){"use strict";const e="http://www.w3.org/2000/svg";class i{constructor(t,e){this.width=e.width,this.height=e.height,this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this.width.toString()),this.svg.setAttribute("height",this.height.toString()),this.svg.style.backgroundColor=e.backgroundColor||"#ffffff",this.mainGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this.mainGroup),this.tooltip=document.createElementNS("http://www.w3.org/2000/svg","g"),this.tooltip.style.display="none",this.tooltipBackground=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.tooltipBackground.setAttribute("fill","white"),this.tooltipBackground.setAttribute("stroke","black"),this.tooltipBackground.setAttribute("rx","4"),this.tooltipBackground.setAttribute("ry","4"),this.tooltipText=document.createElementNS("http://www.w3.org/2000/svg","text"),this.tooltipText.setAttribute("fill","black"),this.tooltipText.setAttribute("font-size","12px"),this.tooltip.appendChild(this.tooltipBackground),this.tooltip.appendChild(this.tooltipText),this.svg.appendChild(this.tooltip),t.appendChild(this.svg)}setupInteraction(){let t=!1,e=0,i=0,s={x:0,y:0,scale:1};this.svg.addEventListener("mousedown",(s=>{t=!0,e=s.clientX,i=s.clientY})),this.svg.addEventListener("mousemove",(n=>{if(!t)return;const o=n.clientX-e,r=n.clientY-i;s.x+=o,s.y+=r,e=n.clientX,i=n.clientY,this.updateTransform(s)})),this.svg.addEventListener("mouseup",(()=>{t=!1})),this.svg.addEventListener("wheel",(t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1;s.scale*=e,this.updateTransform(s)}))}updateTransform(t){this.mainGroup.setAttribute("transform",`translate(${t.x},${t.y}) scale(${t.scale})`)}resize(t,e){this.width=t,this.height=e,this.svg.setAttribute("width",t.toString()),this.svg.setAttribute("height",e.toString()),this.svg.setAttribute("viewBox",`0 0 ${t} ${e}`)}clear(){for(;this.mainGroup.firstChild;)this.mainGroup.removeChild(this.mainGroup.firstChild)}drawBar(t,e,i,s,n,o={}){const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",t.toString()),r.setAttribute("y",e.toString()),r.setAttribute("width",i.toString()),r.setAttribute("height",s.toString()),r.setAttribute("fill",n),o.isHovered&&(r.setAttribute("stroke","#000000"),r.setAttribute("stroke-width","2"),r.setAttribute("fill-opacity","0.8")),o.interactive&&(r.style.cursor="pointer",o.tooltip&&(r.addEventListener("mouseenter",(t=>{var e;this.showTooltip(o.tooltip,t.clientX,t.clientY),null===(e=o.onHover)||void 0===e||e.call(o)})),r.addEventListener("mouseleave",(()=>{var t;this.hideTooltip(),null===(t=o.onLeave)||void 0===t||t.call(o)})),r.addEventListener("mousemove",(t=>{this.updateTooltipPosition(t.clientX,t.clientY)})))),this.mainGroup.appendChild(r)}getHighContrastColor(t){const e=this.hexToRgb(t);if(!e)return t;return(299*e.r+587*e.g+114*e.b)/1e3>128?"#000000":"#FFFFFF"}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}setupBarInteraction(t){t.addEventListener("mouseenter",(e=>{const i=t.getAttribute("data-tooltip");i&&this.showTooltip(i,e.clientX,e.clientY)})),t.addEventListener("mouseleave",(()=>{this.hideTooltip()}))}clientToSVGPoint(t,e){var i;const s=this.svg.createSVGPoint();s.x=t,s.y=e;const n=s.matrixTransform(null===(i=this.svg.getScreenCTM())||void 0===i?void 0:i.inverse());return{x:n.x,y:n.y}}showTooltip(t,e,i){const s=this.clientToSVGPoint(e,i);for(;this.tooltipText.firstChild;)this.tooltipText.removeChild(this.tooltipText.firstChild);const n=document.createElementNS("http://www.w3.org/2000/svg","tspan");n.textContent=t,n.setAttribute("x","5"),n.setAttribute("y","15"),this.tooltipText.appendChild(n);const o=this.tooltipText.getBBox(),r=o.width+10,a=o.height+10;let h=s.x+10,l=s.y-a-10;h+r>this.width&&(h=s.x-r-10),l<0&&(l=s.y+20),this.tooltipBackground.setAttribute("x",h.toString()),this.tooltipBackground.setAttribute("y",l.toString()),this.tooltipBackground.setAttribute("width",r.toString()),this.tooltipBackground.setAttribute("height",a.toString()),this.tooltipText.setAttribute("transform",`translate(${h}, ${l})`),this.tooltip.style.display=""}hideTooltip(){this.tooltip.style.display="none"}updateTooltipPosition(t,e){const i=this.clientToSVGPoint(t,e),s=this.tooltipText.getBBox(),n=s.width+10,o=s.height+10;let r=i.x+10,a=i.y-o-10;r+n>this.width&&(r=i.x-n-10),a<0&&(a=i.y+20),this.tooltipBackground.setAttribute("x",r.toString()),this.tooltipBackground.setAttribute("y",a.toString()),this.tooltipText.setAttribute("transform",`translate(${r}, ${a})`)}drawPattern(t,i,s,n,o,r){const a=document.createElementNS(e,"rect");if(a.setAttribute("x",t.toString()),a.setAttribute("y",i.toString()),a.setAttribute("width",s.toString()),a.setAttribute("height",n.toString()),a.setAttribute("fill",o),a.setAttribute("fill-opacity","0.3"),r)switch(r){case"lowValue":a.setAttribute("stroke","red"),a.setAttribute("stroke-dasharray","4,4");break;case"stagnation":a.setAttribute("stroke","orange"),a.setAttribute("stroke-width","2")}this.mainGroup.appendChild(a)}drawText(t,i,s,n={}){const o=document.createElementNS(e,"text"),r=[["x",t.toString()],["y",i.toString()],["fill",n.color||"black"],["font-family",n.fontFamily||"monospace"],["font-size",(n.fontSize||12).toString()]];n.stroke&&(r.push(["stroke",n.stroke]),r.push(["stroke-width",(n.strokeWidth||1).toString()])),r.forEach((([t,e])=>o.setAttribute(t,e))),o.textContent=s,this.mainGroup.appendChild(o)}drawLine(t,e,i,s,n,o){const r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1",t.toString()),r.setAttribute("y1",e.toString()),r.setAttribute("x2",i.toString()),r.setAttribute("y2",s.toString()),r.setAttribute("stroke",n),r.setAttribute("stroke-width",o.toString()),this.mainGroup.appendChild(r)}getSVGElement(){return this.svg}}class s{constructor(t){this.threshold=t.threshold,this.consecutiveDays=t.consecutiveDays}findPatterns(t){if(t.length<this.consecutiveDays)return[];const e=[],i=this.calculateValueRange(t),s=Math.min(...t.map((t=>t.y)))+i*this.threshold;let n=[];return t.forEach(((i,o)=>{i.y<=s?n.push(o):(this.isValidSequence(n,t)&&e.push({start:n[0],end:n[n.length-1]}),n=[])})),this.isValidSequence(n,t)&&e.push({start:n[0],end:n[n.length-1]}),e}calculateValueRange(t){const e=t.map((t=>t.y));return Math.max(...e)-Math.min(...e)}isValidSequence(t,e){if(t.length<this.consecutiveDays)return!1;for(let i=1;i<t.length;i++){if((e[t[i]].x.valueOf()-e[t[i-1]].x.valueOf())/864e5>1.1)return!1}return!0}}class n{constructor(t){this.consecutiveDays=t.consecutiveDays,this.changeThreshold=t.changeThreshold,this.activeChangePercentage=t.activeChangePercentage}findPatterns(t){if(t.length<this.consecutiveDays)return[];const e=[],i=this.calculateAverageChange(t);if(!this.hasEnoughActiveChanges(t,i))return[];let s=[];const n=i*this.changeThreshold;return t.forEach(((i,o)=>{s.push(o),(o===t.length-1||Math.abs(t[o+1].y-i.y)>n)&&(this.isStagnationPeriod(s,t,n)&&e.push({start:s[0],end:s[s.length-1]}),s=[])})),e}calculateAverageChange(t){if(t.length<2)return 0;let e=0,i=0;for(let s=1;s<t.length;s++){const n=Math.abs(t[s].y-t[s-1].y);n>0&&(e+=n,i++)}return i>0?e/i:0}hasEnoughActiveChanges(t,e){if(t.length<2)return!1;let i=0;const s=e*this.changeThreshold;for(let e=1;e<t.length;e++){Math.abs(t[e].y-t[e-1].y)>s&&i++}return i/(t.length-1)>=this.activeChangePercentage}isStagnationPeriod(t,e,i){if(t.length<this.consecutiveDays)return!1;for(let i=1;i<t.length;i++){if((e[t[i]].x.valueOf()-e[t[i-1]].x.valueOf())/864e5>1.1)return!1}for(let s=1;s<t.length;s++){if(Math.abs(e[t[s]].y-e[t[s-1]].y)>i)return!1}return!0}}function o(t){return 0===t.length?0:t.reduce(((t,e)=>t+e),0)/t.length}function r(t){if(0===t.length)return 0;const e=[...t].sort(((t,e)=>t-e)),i=Math.floor(e.length/2);return e.length%2==0?(e[i-1]+e[i])/2:e[i]}function a(t,e){if(e<1||e>t.length)return t;const i=[];for(let s=0;s<t.length-e+1;s++){const n=t.slice(s,s+e);i.push(o(n))}return i}function h(t){return t.toISOString()}t.MTPlot=class{constructor(t,e=[],o={}){this.trendLine=null,this.isDirty=!1,this.hoveredBarIndex=null,this.updateTimeout=null,this.refreshDelay=100,this.resizeObserver=null,this.tooltip=null,this.worker=null,this.zoom={scale:1,offset:{x:0,y:0}},this.clusterData=[];const r=document.getElementById(t);if(!r)throw new Error(`No element found with id: ${t}`);this.container=r,this.options={width:800,height:400,responsive:!0,theme:{backgroundColor:"#ffffff",barColor:"#4CAF50",textColor:"#000000",gridColor:"#e0e0e0"},patterns:{lowValue:{threshold:.02,consecutiveDays:2},stagnation:{consecutiveDays:3,changeThreshold:.2,activeChangePercentage:.85}},accessibility:{enableKeyboardNavigation:!0,enableScreenReader:!0,highContrast:!1,ariaLabel:"Time series chart"},interaction:{enableZoom:!0,enablePan:!0,tooltipFormat:t=>`${h(t.x)}: ${t.y}`,onPointClick:void 0},performance:{enableVirtualization:!0,clusteringThreshold:1e3,useWebWorker:!0},statistics:{enabled:!1,showMean:!1,showMedian:!1,showMovingAverage:!1,lineColor:{mean:"#FF0000",median:"#0000FF",movingAverage:"#00FF00"}},...o},this.lowValueDetector=new s(this.options.patterns.lowValue),this.stagnationDetector=new n(this.options.patterns.stagnation),this.renderer=new i(this.container,{width:this.getWidth(),height:this.getHeight(),backgroundColor:this.options.theme.backgroundColor}),this.data=this.processInitialData(e),this.options.responsive&&this.setupResizeHandling(),this.render()}setupTooltip(){this.tooltip=document.createElement("div"),this.tooltip.style.cssText="\n      position: absolute;\n      display: none;\n      background: white;\n      border: 1px solid #ccc;\n      padding: 8px;\n      border-radius: 4px;\n      pointer-events: none;\n      z-index: 1000;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    ",document.body.appendChild(this.tooltip)}setupWebWorker(){const t=new Blob(["\n      self.onmessage = function(e) {\n        const { data, patterns } = e.data;\n        const results = {\n          lowValue: findLowValuePatterns(data, patterns.lowValue),\n          stagnation: findStagnationPatterns(data, patterns.stagnation)\n        };\n        self.postMessage(results);\n      };\n    "],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.onmessage=t=>{this.handleWorkerResults(t.data)}}setupAccessibility(){var t,e;const i=this.renderer.getSVGElement();i.setAttribute("role","img"),i.setAttribute("aria-label",(null===(t=this.options.accessibility)||void 0===t?void 0:t.ariaLabel)||"Time series chart"),(null===(e=this.options.accessibility)||void 0===e?void 0:e.enableKeyboardNavigation)&&(i.setAttribute("tabindex","0"),i.addEventListener("keydown",this.handleKeyboardNavigation.bind(this)))}setupResizeHandling(){this.resizeObserver=new ResizeObserver((t=>{for(const e of t)e.target===this.container&&this.handleResize()})),this.resizeObserver.observe(this.container),window.addEventListener("resize",(()=>{this.handleResize()}))}handleResize(){const t=this.getWidth(),e=this.getHeight();this.renderer.resize(t,e),this.triggerUpdate()}getWidth(){return this.options.responsive?this.container.clientWidth:this.options.width}getHeight(){return this.options.responsive?this.container.clientHeight:this.options.height}processInitialData(t){let e=[...t].sort(((t,e)=>t.x.valueOf()-e.x.valueOf()));return e.length>0&&this.calculateTrendLine(e),e}calculateTrendLine(t){const e=this.lowValueDetector.findPatterns(t),i=new Set;e.forEach((t=>{for(let e=t.start;e<=t.end;e++)i.add(e)}));const s=t.filter(((t,e)=>!i.has(e)));if(s.length<2)return;const n=s.map(((t,e)=>e)),o=s.map((t=>t.y)),r=n.reduce(((t,e)=>t+e),0)/n.length,a=o.reduce(((t,e)=>t+e),0)/o.length,h=n.reduce(((t,e,i)=>t+(e-r)*(o[i]-a)),0)/n.reduce(((t,e)=>t+(e-r)*(e-r)),0),l=a-h*r;this.trendLine={slope:h,intercept:l}}handleKeyboardNavigation(t){var e;if(null===(e=this.options.accessibility)||void 0===e?void 0:e.enableKeyboardNavigation){switch(t.key){case"ArrowLeft":this.zoom.offset.x-=10;break;case"ArrowRight":this.zoom.offset.x+=10;break;case"ArrowUp":this.zoom.scale*=1.1;break;case"ArrowDown":this.zoom.scale/=1.1}this.triggerUpdate()}}handleWorkerResults(t){this.drawPatterns(this.calculateValueRange(),this.calculateTimeRange())}setupEventListeners(){this.container.addEventListener("mousemove",(t=>{var e,i;const s=this.container.getBoundingClientRect(),n=t.clientX-s.left;t.clientY,s.top;const o=this.calculateTimeRange(),r=this.getTimeFromX(n,o),a=this.findClosestPoint(r);if(a){const s=(null===(i=null===(e=this.options.interaction)||void 0===e?void 0:e.tooltipFormat)||void 0===i?void 0:i.call(e,a))||`Date: ${a.x.toLocaleDateString()}, Value: ${a.y.toFixed(2)}`;this.renderer.showTooltip(s,t.clientX,t.clientY)}})),this.container.addEventListener("mouseleave",(()=>{this.renderer.hideTooltip()}));new ResizeObserver((()=>{this.triggerUpdate()})).observe(this.container),this.container.tabIndex=0,this.container.addEventListener("keydown",this.handleKeyboardNavigation.bind(this))}getTimeFromX(t,e){const i=t/this.options.width;return e.min+(e.max-e.min)*i}findClosestPoint(t){if(!this.data.length)return null;let e=this.data[0],i=Math.abs(e.x.valueOf()-t);for(const s of this.data){const n=Math.abs(s.x.valueOf()-t);n<i&&(i=n,e=s)}return e}drawTrendLine(t,e){if(!this.trendLine||!this.data.length)return;const{slope:i,intercept:s}=this.trendLine,n=this.getXPosition(this.data[0].x,e),o=this.getXPosition(this.data[this.data.length-1].x,e),r=this.scaleY(0*i+s,t),a=this.scaleY(i*(this.data.length-1)+s,t);this.renderer.drawLine(n,r,o,a,"#ff0000",2)}render(){var t;if(!this.isDirty)return;if(this.renderer.clear(),0===this.data.length)return;const{width:e,height:i}=this.options,s=this.calculateValueRange(),n=this.calculateTimeRange();this.drawPatterns(s,n),this.drawBars(s,n),this.drawTrendLine(s,n),(null===(t=this.options.statistics)||void 0===t?void 0:t.enabled)&&this.drawStatistics(s),this.isDirty=!1}addData(t){this.data.push(t),this.data.sort(((t,e)=>t.x.valueOf()-e.x.valueOf())),this.calculateTrendLine(this.data),this.triggerUpdate()}triggerUpdate(){this.updateTimeout&&window.clearTimeout(this.updateTimeout),this.isDirty=!0,this.updateTimeout=window.setTimeout((()=>{this.update(),this.updateTimeout=null}),this.refreshDelay)}update(){var t;if(!this.isDirty)return;if(this.renderer.clear(),0===this.data.length)return;const{width:e,height:i}=this.options,s=this.calculateValueRange(),n=this.calculateTimeRange();this.drawPatterns(s,n),this.drawBars(s,n),this.drawTrendLine(s,n),(null===(t=this.options.statistics)||void 0===t?void 0:t.enabled)&&this.drawStatistics(s),this.isDirty=!1}calculateValueRange(){const t=this.data.map((t=>t.y));return{min:Math.min(...t),max:Math.max(...t)}}calculateTimeRange(){const t=this.data.map((t=>t.x.valueOf()));return{min:Math.min(...t),max:Math.max(...t)}}drawPatterns(t,e){this.lowValueDetector.findPatterns(this.data).forEach((t=>{const i=this.getXPosition(this.data[t.start].x,e),s=this.getXPosition(this.data[t.end].x,e);this.renderer.drawPattern(i,0,s-i,this.getHeight(),this.options.theme.lowValueColor,"lowValue")}));this.stagnationDetector.findPatterns(this.data).forEach((t=>{const i=this.getXPosition(this.data[t.start].x,e),s=this.getXPosition(this.data[t.end].x,e);this.renderer.drawPattern(i,0,s-i,this.getHeight(),this.options.theme.stagnationColor,"stagnation")}))}drawBars(t,e){var i,s,n;for(let o=0;o<this.data.length;o++){const r=this.data[o],a=this.data[o+1],h=this.getXPosition(r.x,e),l=this.scaleY(r.y,t),d=a?this.getXPosition(a.x,e)-h:10,c=this.options.height-l,u=(null===(s=null===(i=this.options.interaction)||void 0===i?void 0:i.tooltipFormat)||void 0===s?void 0:s.call(i,r))||`Date: ${r.x.toLocaleDateString()}, Value: ${r.y.toFixed(2)}`,g=o===this.hoveredBarIndex;this.renderer.drawBar(h,l,d,c,this.options.theme.barColor,{interactive:!0,tooltip:u,highContrast:null===(n=this.options.accessibility)||void 0===n?void 0:n.highContrast,isHovered:g,onHover:()=>{this.hoveredBarIndex=o,this.triggerUpdate()},onLeave:()=>{this.hoveredBarIndex=null,this.triggerUpdate()}})}}drawStatistics(t){const e=this.data.map((t=>t.y)),i=o(e),s=r(e);this.renderer.drawPattern(0,this.scaleY(i,t),this.options.width,1,"rgba(0,0,255,0.5)"),this.renderer.drawPattern(0,this.scaleY(s,t),this.options.width,1,"rgba(0,255,0,0.5)")}getXPosition(t,e){return(t.valueOf()-e.min)/(e.max-e.min)*this.options.width}scaleY(t,e){return this.options.height-(t-e.min)/(e.max-e.min)*this.options.height}getStatistics(){const t=this.data.map((t=>t.y));return{mean:o(t),median:r(t),movingAverage:a(t,5)}}exportToCSV(){return[["Date","Value"],...this.data.map((t=>[t.x.toISOString(),t.y.toString()]))].map((t=>t.join(","))).join("\n")}exportToSVG(){return this.renderer.getSVGElement().outerHTML}setTheme(t){this.options.theme={...this.options.theme,...t},this.triggerUpdate()}setPatternOptions(t){t.lowValue&&(this.lowValueDetector=new s({...this.options.patterns.lowValue,...t.lowValue})),t.stagnation&&(this.stagnationDetector=new n({...this.options.patterns.stagnation,...t.stagnation})),this.options.patterns={...this.options.patterns,...t},this.triggerUpdate()}setOptions(t){var e,i,o,r;this.options={...this.options,...t},void 0===t.width&&void 0===t.height||this.renderer.resize(this.getWidth(),this.getHeight()),t.patterns&&(t.patterns.lowValue&&(this.lowValueDetector=new s({...null!==(i=null===(e=this.options.patterns)||void 0===e?void 0:e.lowValue)&&void 0!==i?i:{},...t.patterns.lowValue})),t.patterns.stagnation&&(this.stagnationDetector=new n({...null!==(r=null===(o=this.options.patterns)||void 0===o?void 0:o.stagnation)&&void 0!==r?r:{},...t.patterns.stagnation}))),this.triggerUpdate()}},t.calculateMean=o,t.calculateMedian=r,t.calculateMovingAverage=a,t.calculatePercentile=function(t,e){if(0===t.length)return 0;if(e<0||e>100)throw new Error("Percentile must be between 0 and 100");const i=[...t].sort(((t,e)=>t-e)),s=e/100*(i.length-1),n=Math.floor(s),o=Math.ceil(s);if(n===o)return i[n];const r=s-n;return i[n]*(1-r)+i[o]*r},t.calculateStandardDeviation=function(t){if(t.length<2)return 0;const e=o(t),i=o(t.map((t=>Math.pow(t-e,2))));return Math.sqrt(i)},t.formatDate=h,t.getDateRange=function(t){return{min:new Date(Math.min(...t.map((t=>t.valueOf())))),max:new Date(Math.max(...t.map((t=>t.valueOf()))))}}}));
//# sourceMappingURL=mtplot.min.js.map
